#!/bin/bash
# shellcheck disable=SC2155
#
# llng-bastion-setup - Configure a server as an SSH bastion with LLNG
#
# This script configures a Linux server as an SSH bastion host that:
# - Accepts SSH certificate authentication via LLNG CA
# - Records all sessions using llng-session-recorder
# - Authenticates users via LLNG PAM module
# - Disables direct sudo access
#
# Copyright (C) 2025 Linagora
# Author: Xavier Guimard <xguimard@linagora.com>
# License: AGPL-3.0

set -euo pipefail

VERSION="1.0.0"
PROG_NAME=$(basename "$0")

# Default configuration
PORTAL_URL=""
SERVER_GROUP="bastion"
SERVER_TOKEN=""
NON_INTERACTIVE=false
VERIFY_SSL=true
TIMEOUT=30
DRY_RUN=false
BACKUP_DIR="/var/backup/llng-setup-$(date +%Y%m%d-%H%M%S)"

# Paths
SSH_CA_FILE="/etc/ssh/llng_ca.pub"
SSHD_CONFIG="/etc/ssh/sshd_config"
SSHD_CONFIG_DIR="/etc/ssh/sshd_config.d"
PAM_SSHD="/etc/pam.d/sshd"
PAM_LLNG_CONF="/etc/security/pam_llng.conf"
PAM_LLNG_TOKEN="/etc/security/pam_llng.token"
SESSION_RECORDER="/usr/sbin/llng-session-recorder"
SESSION_RECORDER_CONF="/etc/llng/session-recorder.conf"

# Colors (only if terminal)
if [ -t 1 ]; then
    RED='\033[0;31m'
    GREEN='\033[0;32m'
    YELLOW='\033[1;33m'
    BLUE='\033[0;34m'
    NC='\033[0m'
else
    RED=''
    GREEN=''
    YELLOW=''
    BLUE=''
    NC=''
fi

info() { echo -e "${GREEN}[INFO]${NC} $*"; }
warn() { echo -e "${YELLOW}[WARN]${NC} $*" >&2; }
error() { echo -e "${RED}[ERROR]${NC} $*" >&2; }
step() { echo -e "${BLUE}[STEP]${NC} $*"; }

# Check if running as root
check_root() {
    if [ "$(id -u)" -ne 0 ]; then
        error "This script must be run as root"
        exit 1
    fi
}

# Backup a file before modifying
backup_file() {
    local file="$1"
    if [ -f "$file" ]; then
        mkdir -p "$BACKUP_DIR"
        cp -a "$file" "$BACKUP_DIR/"
        info "Backed up: $file"
    fi
}

# Confirm action (unless non-interactive)
confirm() {
    local msg="$1"
    if [ "$NON_INTERACTIVE" = "true" ]; then
        return 0
    fi

    echo -en "${YELLOW}$msg [y/N] ${NC}"
    read -r response
    case "$response" in
        [yY][eE][sS]|[yY]) return 0 ;;
        *) return 1 ;;
    esac
}

# Build curl options
curl_opts() {
    local opts=("-s" "-f" "--connect-timeout" "$TIMEOUT")
    if [ "$VERIFY_SSL" = "false" ]; then
        opts+=("-k")
    fi
    echo "${opts[@]}"
}

# Download SSH CA public key
download_ca_key() {
    step "Downloading SSH CA public key from LLNG..."

    local curl_options
    curl_options=$(curl_opts)

    local ca_key
    # shellcheck disable=SC2086
    ca_key=$(curl $curl_options "${PORTAL_URL}/ssh/ca") || {
        error "Failed to download CA public key from ${PORTAL_URL}/ssh/ca"
        error "Make sure sshCaActivation is enabled in LLNG"
        return 1
    }

    if [ -z "$ca_key" ] || [[ ! "$ca_key" =~ ^ssh- ]]; then
        error "Invalid CA public key received"
        return 1
    fi

    if [ "$DRY_RUN" = "true" ]; then
        info "[DRY-RUN] Would write CA key to $SSH_CA_FILE"
        return 0
    fi

    backup_file "$SSH_CA_FILE"
    echo "$ca_key" > "$SSH_CA_FILE"
    chmod 644 "$SSH_CA_FILE"
    info "CA public key saved to $SSH_CA_FILE"
}

# Configure sshd
configure_sshd() {
    step "Configuring SSH server..."

    local config_content="# LemonLDAP::NG Bastion Configuration
# Generated by $PROG_NAME on $(date)

# Trust LLNG SSH CA for certificate authentication
TrustedUserCAKeys $SSH_CA_FILE

# Enable public key (certificate) authentication
PubkeyAuthentication yes

# Disable password authentication (use certificates only)
PasswordAuthentication no
KbdInteractiveAuthentication no

# Allow agent forwarding for bastion use
AllowAgentForwarding yes

# Record all sessions via LLNG session recorder
ForceCommand $SESSION_RECORDER

# Enable PAM for authorization
UsePAM yes

# Disable X11 forwarding for security
X11Forwarding no
"

    if [ "$DRY_RUN" = "true" ]; then
        info "[DRY-RUN] Would create LLNG sshd configuration"
        echo "$config_content"
        return 0
    fi

    # Use sshd_config.d if available (modern systems)
    if [ -d "$SSHD_CONFIG_DIR" ]; then
        local llng_config="$SSHD_CONFIG_DIR/50-llng-bastion.conf"
        backup_file "$llng_config"
        echo "$config_content" > "$llng_config"
        chmod 644 "$llng_config"
        info "Created $llng_config"
    else
        # Append to main sshd_config
        backup_file "$SSHD_CONFIG"

        # Check if already configured
        if grep -q "TrustedUserCAKeys.*llng" "$SSHD_CONFIG" 2>/dev/null; then
            warn "LLNG configuration already exists in $SSHD_CONFIG"
        else
            echo "" >> "$SSHD_CONFIG"
            echo "$config_content" >> "$SSHD_CONFIG"
            info "Added LLNG configuration to $SSHD_CONFIG"
        fi
    fi

    # Validate sshd config
    if ! sshd -t 2>/dev/null; then
        error "SSH configuration is invalid!"
        error "Please check the configuration and fix manually"
        return 1
    fi

    info "SSH configuration is valid"
}

# Configure PAM for SSH
configure_pam_sshd() {
    step "Configuring PAM for SSH..."

    local pam_content="# PAM configuration for SSH with LemonLDAP::NG bastion
# Generated by $PROG_NAME on $(date)
#
# Authentication: Handled by SSH certificates (not PAM)
# Authorization: LLNG checks if user can access this bastion
# Session: Standard Unix session handling

# Authentication - permit (handled by SSH certs)
auth       required     pam_permit.so

# Authorization - check with LLNG (certificate-aware mode)
account    required     pam_llng.so ssh_cert_aware=true

# Session - standard Unix session
session    required     pam_unix.so
session    optional     pam_llng.so
"

    if [ "$DRY_RUN" = "true" ]; then
        info "[DRY-RUN] Would configure PAM for SSH"
        echo "$pam_content"
        return 0
    fi

    backup_file "$PAM_SSHD"
    echo "$pam_content" > "$PAM_SSHD"
    chmod 644 "$PAM_SSHD"
    info "Configured $PAM_SSHD"
}

# Configure PAM LLNG module
configure_pam_llng() {
    step "Configuring PAM LLNG module..."

    local config_content="# LemonLDAP::NG PAM module configuration
# Generated by $PROG_NAME on $(date)

# Portal URL (required)
portal_url = $PORTAL_URL

# Server authentication token file
server_token_file = $PAM_LLNG_TOKEN

# Server group for authorization rules
server_group = $SERVER_GROUP

# HTTP settings
timeout = 10
verify_ssl = $VERIFY_SSL

# Cache settings (reduce load on portal)
cache_enabled = true
cache_dir = /var/cache/pam_llng
cache_ttl = 300

# Logging
log_level = info

# Audit logging
audit_enabled = true
audit_to_syslog = true
"

    if [ "$DRY_RUN" = "true" ]; then
        info "[DRY-RUN] Would create PAM LLNG configuration"
        echo "$config_content"
        return 0
    fi

    backup_file "$PAM_LLNG_CONF"
    echo "$config_content" > "$PAM_LLNG_CONF"
    chmod 600 "$PAM_LLNG_CONF"
    info "Created $PAM_LLNG_CONF"

    # Create cache directory
    mkdir -p /var/cache/pam_llng
    chmod 750 /var/cache/pam_llng
}

# Configure session recorder
configure_session_recorder() {
    step "Configuring session recorder..."

    # Check if session recorder is installed
    if [ ! -x "$SESSION_RECORDER" ]; then
        warn "Session recorder not found at $SESSION_RECORDER"
        warn "Make sure pam-llng package is installed"
    fi

    local config_content="# LemonLDAP::NG Session Recorder Configuration
# Generated by $PROG_NAME on $(date)

# Directory for session recordings
sessions_dir = /var/lib/llng-sessions

# Recording format (script is always available)
format = script

# Maximum session duration (8 hours)
max_duration = 28800
"

    if [ "$DRY_RUN" = "true" ]; then
        info "[DRY-RUN] Would create session recorder configuration"
        return 0
    fi

    mkdir -p "$(dirname "$SESSION_RECORDER_CONF")"
    backup_file "$SESSION_RECORDER_CONF"
    echo "$config_content" > "$SESSION_RECORDER_CONF"
    chmod 644 "$SESSION_RECORDER_CONF"
    info "Created $SESSION_RECORDER_CONF"

    # Create sessions directory
    mkdir -p /var/lib/llng-sessions
    chmod 700 /var/lib/llng-sessions
}

# Enroll server with LLNG
enroll_server() {
    step "Enrolling server with LLNG..."

    if [ -n "$SERVER_TOKEN" ]; then
        # Token provided directly
        if [ "$DRY_RUN" = "true" ]; then
            info "[DRY-RUN] Would save provided server token"
            return 0
        fi

        echo "$SERVER_TOKEN" > "$PAM_LLNG_TOKEN"
        chmod 600 "$PAM_LLNG_TOKEN"
        info "Server token saved"
    elif [ -x /usr/sbin/llng-pam-enroll ]; then
        # Use enrollment script
        if [ "$DRY_RUN" = "true" ]; then
            info "[DRY-RUN] Would run llng-pam-enroll"
            return 0
        fi

        local enroll_opts=("-p" "$PORTAL_URL" "-g" "$SERVER_GROUP")
        if [ "$VERIFY_SSL" = "false" ]; then
            enroll_opts+=("-k")
        fi
        if [ "$NON_INTERACTIVE" = "true" ]; then
            error "Cannot enroll in non-interactive mode without --token"
            return 1
        fi

        /usr/sbin/llng-pam-enroll "${enroll_opts[@]}"
    else
        warn "Server not enrolled. Run llng-pam-enroll manually after installation."
    fi
}

# Restart SSH service
restart_sshd() {
    step "Restarting SSH service..."

    if [ "$DRY_RUN" = "true" ]; then
        info "[DRY-RUN] Would restart sshd"
        return 0
    fi

    if systemctl is-active --quiet sshd 2>/dev/null; then
        systemctl restart sshd
        info "Restarted sshd.service"
    elif systemctl is-active --quiet ssh 2>/dev/null; then
        systemctl restart ssh
        info "Restarted ssh.service"
    else
        warn "Could not restart SSH service automatically"
        warn "Please restart it manually: systemctl restart sshd"
    fi
}

# Print summary
print_summary() {
    echo ""
    echo "┌─────────────────────────────────────────────────────────┐"
    echo "│           Bastion Configuration Complete                 │"
    echo "└─────────────────────────────────────────────────────────┘"
    echo ""
    echo "Configuration:"
    echo "  Portal URL:    $PORTAL_URL"
    echo "  Server Group:  $SERVER_GROUP"
    echo "  CA Key:        $SSH_CA_FILE"
    echo ""
    echo "Features enabled:"
    echo "  ✓ SSH certificate authentication"
    echo "  ✓ Session recording (ForceCommand)"
    echo "  ✓ LLNG authorization"
    echo "  ✓ Password authentication disabled"
    echo ""
    echo "Backup location: $BACKUP_DIR"
    echo ""
    echo "Next steps:"
    echo "  1. Verify SSH connectivity from another terminal"
    echo "  2. Test certificate authentication with llng-ssh-cert"
    echo "  3. Check session recordings in /var/lib/llng-sessions/"
    echo ""
}

# Usage
usage() {
    cat << EOF
Usage: $PROG_NAME --portal URL [OPTIONS]

Configure a server as an SSH bastion with LemonLDAP::NG integration.

Required:
  -p, --portal URL        LLNG portal URL

Options:
  -g, --server-group NAME Server group name (default: $SERVER_GROUP)
  -t, --token-file FILE   Read server token from file (use - for stdin)
  -y, --yes               Non-interactive mode (requires --token-file)
  -k, --insecure          Skip SSL certificate verification
  -n, --dry-run           Show what would be done without making changes
  -h, --help              Show this help
  -V, --version           Show version

Example:
  $PROG_NAME --portal https://auth.example.com --server-group bastion

What this script does:
  1. Downloads SSH CA public key from LLNG
  2. Configures sshd for certificate authentication
  3. Enables session recording via ForceCommand
  4. Configures PAM for LLNG authorization
  5. Enrolls the server with LLNG (Device Authorization)
  6. Restarts SSH service

EOF
    exit 0
}

# Parse arguments
parse_args() {
    while [ $# -gt 0 ]; do
        case "$1" in
            -p|--portal)
                if [ -z "${2:-}" ] || [[ "${2:-}" == -* ]]; then
                    error "Option $1 requires an argument"
                    exit 1
                fi
                PORTAL_URL="$2"
                shift 2
                ;;
            -g|--server-group)
                if [ -z "${2:-}" ] || [[ "${2:-}" == -* ]]; then
                    error "Option $1 requires an argument"
                    exit 1
                fi
                SERVER_GROUP="$2"
                shift 2
                ;;
            -t|--token-file)
                if [ -z "${2:-}" ] || [[ "${2:-}" == -* ]]; then
                    error "Option $1 requires an argument"
                    exit 1
                fi
                if [ "$2" = "-" ]; then
                    SERVER_TOKEN=$(cat)
                elif [ -f "$2" ]; then
                    SERVER_TOKEN=$(cat "$2")
                else
                    error "Token file not found: $2"
                    exit 1
                fi
                shift 2
                ;;
            -y|--yes)
                NON_INTERACTIVE=true
                shift
                ;;
            -k|--insecure)
                VERIFY_SSL=false
                shift
                ;;
            -n|--dry-run)
                DRY_RUN=true
                shift
                ;;
            -h|--help)
                usage
                ;;
            -V|--version)
                echo "$PROG_NAME version $VERSION"
                exit 0
                ;;
            *)
                error "Unknown option: $1"
                echo "Use --help for usage information"
                exit 1
                ;;
        esac
    done
}

# Main
main() {
    parse_args "$@"

    # Validate required parameters
    if [ -z "$PORTAL_URL" ]; then
        error "Portal URL is required (-p/--portal)"
        exit 1
    fi

    # Remove trailing slash
    PORTAL_URL="${PORTAL_URL%/}"

    # Check root
    check_root

    # Check dependencies
    for cmd in curl sshd; do
        if ! command -v "$cmd" >/dev/null 2>&1; then
            error "Required command not found: $cmd"
            exit 1
        fi
    done

    echo ""
    echo "┌─────────────────────────────────────────────────────────┐"
    echo "│        LemonLDAP::NG Bastion Setup                       │"
    echo "└─────────────────────────────────────────────────────────┘"
    echo ""
    echo "This script will configure this server as an SSH bastion."
    echo ""
    echo "Portal URL:    $PORTAL_URL"
    echo "Server Group:  $SERVER_GROUP"
    echo ""

    if [ "$DRY_RUN" = "true" ]; then
        warn "DRY-RUN MODE - No changes will be made"
        echo ""
    fi

    if ! confirm "Continue with bastion setup?"; then
        info "Aborted"
        exit 0
    fi

    echo ""

    # Run setup steps
    download_ca_key || exit 1
    configure_sshd || exit 1
    configure_pam_sshd || exit 1
    configure_pam_llng || exit 1
    configure_session_recorder || exit 1
    enroll_server || warn "Server enrollment skipped or failed"

    if [ "$DRY_RUN" = "false" ]; then
        restart_sshd || warn "Failed to restart SSH"
    fi

    print_summary
}

main "$@"
