#!/bin/sh
set -e

. /usr/share/debconf/confmodule

CONF_FILE="/etc/open-bastion/openbastion.conf"
BACKUP_DIR="/var/backups/open-bastion"
PAM_SSHD="/etc/pam.d/sshd"
PAM_SUDO="/etc/pam.d/sudo"

# Backup a PAM file if not already backed up
backup_pam_file() {
    file="$1"
    name="$2"
    if [ -f "$file" ] && [ ! -f "$BACKUP_DIR/${name}.orig" ]; then
        mkdir -p "$BACKUP_DIR"
        cp -a "$file" "$BACKUP_DIR/${name}.orig"
    fi
}

# Generate PAM configuration for sshd
generate_pam_sshd() {
    mode="$1"
    server_group="$2"
    cat << EOF
# /etc/pam.d/sshd - Configured by open-bastion
# Mode: $mode
# Server group: $server_group
#
EOF
    case "$mode" in
        mode-a)
            cat << EOF
# AUTHENTICATION: Only Open Bastion tokens accepted
auth       sufficient   pam_openbastion.so server_group=$server_group
auth       required     pam_deny.so
EOF
            ;;
        mode-b|mode-d)
            cat << EOF
# AUTHENTICATION: Open Bastion token OR Unix password
auth       sufficient   pam_openbastion.so server_group=$server_group
auth       sufficient   pam_unix.so nullok try_first_pass
auth       required     pam_deny.so
EOF
            ;;
        mode-c)
            cat << 'EOF'
# AUTHENTICATION: SSH keys only (handled by sshd, not PAM)
auth       required     pam_permit.so
EOF
            ;;
    esac
    cat << EOF

# AUTHORIZATION: Open Bastion checks if user can access this server
account    required     pam_openbastion.so server_group=$server_group
account    required     pam_unix.so

# SESSION (pam_openbastion creates Unix account if needed)
session    required     pam_openbastion.so server_group=$server_group
session    required     pam_unix.so
EOF
}

# Generate PAM configuration for sudo
generate_pam_sudo() {
    mode="$1"
    server_group="$2"
    cat << EOF
# /etc/pam.d/sudo - Configured by open-bastion
# Mode: $mode
# Server group: $server_group
#
EOF
    case "$mode" in
        mode-a)
            cat << EOF
# AUTHENTICATION: Only Open Bastion tokens accepted
auth       sufficient   pam_openbastion.so server_group=$server_group
auth       required     pam_deny.so
EOF
            ;;
        mode-b|mode-d)
            cat << EOF
# AUTHENTICATION: Open Bastion token OR Unix password
auth       sufficient   pam_openbastion.so server_group=$server_group
auth       sufficient   pam_unix.so nullok try_first_pass
auth       required     pam_deny.so
EOF
            ;;
        mode-c)
            cat << 'EOF'
# AUTHENTICATION: Permit (for SSH key scenarios)
auth       required     pam_permit.so
EOF
            ;;
    esac
    cat << EOF

# AUTHORIZATION
account    required     pam_openbastion.so server_group=$server_group
account    required     pam_unix.so

# SESSION (pam_openbastion creates Unix account if needed)
session    required     pam_openbastion.so server_group=$server_group
session    required     pam_unix.so
EOF
}

# Generate openbastion.conf
generate_openbastion_conf() {
    portal_url="$1"
    client_id="$2"
    client_secret="$3"
    server_group="$4"
    create_user="$5"

    cat << EOF
# /etc/open-bastion/openbastion.conf
# Configured by open-bastion debconf
# Run 'dpkg-reconfigure open-bastion' to modify

# Open Bastion portal URL
portal_url = $portal_url

# OIDC client credentials
client_id = $client_id
client_secret = $client_secret

# Server authentication
server_token_file = /etc/open-bastion/token
server_group = $server_group

# HTTP settings
timeout = 10
verify_ssl = true

# Cache settings
cache_enabled = true
cache_dir = /var/cache/open-bastion
cache_ttl = 300

# Logging: error, warn, info, debug
log_level = warn

# Auto-create Unix accounts on first login
create_user = $create_user
EOF
}

case "$1" in
    configure)
        # Create config directory
        mkdir -p /etc/open-bastion
        chmod 755 /etc/open-bastion

        db_get open-bastion/pam-mode
        MODE="$RET"

        if [ "$MODE" != "none" ] && [ -n "$MODE" ]; then
            # Get debconf values
            db_get open-bastion/portal-url
            PORTAL_URL="$RET"
            db_get open-bastion/client-id
            CLIENT_ID="$RET"
            db_get open-bastion/client-secret
            CLIENT_SECRET="$RET"
            db_get open-bastion/server-group
            SERVER_GROUP="$RET"
            db_get open-bastion/configure-sudo
            CONFIGURE_SUDO="$RET"
            db_get open-bastion/sudo-server-group
            SUDO_SERVER_GROUP="$RET"
            db_get open-bastion/create-user
            CREATE_USER="$RET"

            # Use main server group for sudo if not specified
            if [ -z "$SUDO_SERVER_GROUP" ]; then
                SUDO_SERVER_GROUP="$SERVER_GROUP"
            fi

            # Generate openbastion.conf if portal URL is provided
            if [ -n "$PORTAL_URL" ]; then
                generate_openbastion_conf "$PORTAL_URL" "$CLIENT_ID" "$CLIENT_SECRET" "$SERVER_GROUP" "$CREATE_USER" > "$CONF_FILE"
                chmod 600 "$CONF_FILE"
                chown root:root "$CONF_FILE"
            fi

            # Backup and configure sshd
            backup_pam_file "$PAM_SSHD" "sshd"
            generate_pam_sshd "$MODE" "$SERVER_GROUP" > "$PAM_SSHD"

            # Configure sudo if requested
            if [ "$CONFIGURE_SUDO" = "true" ]; then
                backup_pam_file "$PAM_SUDO" "sudo"
                generate_pam_sudo "$MODE" "$SUDO_SERVER_GROUP" > "$PAM_SUDO"
            fi

            # Create cache directory
            mkdir -p /var/cache/open-bastion
            chmod 700 /var/cache/open-bastion

            # Create state directory
            mkdir -p /var/lib/open-bastion
            chmod 700 /var/lib/open-bastion

            # Clear secret from debconf database for security
            db_set open-bastion/client-secret ""
        fi
        ;;

    abort-upgrade|abort-remove|abort-deconfigure)
        ;;

    *)
        echo "postinst called with unknown argument '$1'" >&2
        exit 1
        ;;
esac

#DEBHELPER#

exit 0
