# PAM LemonLDAP::NG Configuration File
# /etc/security/pam_llng.conf

# ==============================================================================
# Required Settings
# ==============================================================================

# LemonLDAP::NG portal URL
portal_url = https://auth.example.com

# OIDC client credentials (must match the RP configured in LLNG)
client_id = pam-access
client_secret = your-client-secret-here

# ==============================================================================
# Server Authentication
# ==============================================================================

# Path to file containing the server's access token
# This token is obtained during server enrollment via Device Authorization Grant
# The file should contain only the token and be readable only by root
server_token_file = /etc/security/pam_llng.token

# Server group name for authorization rules
# This must match a group defined in LLNG's pamAccessServerGroups
# Default: "default"
server_group = default

# ==============================================================================
# HTTP Settings
# ==============================================================================

# HTTP timeout in seconds
# Default: 10
timeout = 10

# Verify SSL certificates
# Set to false only for testing with self-signed certificates
# Default: true
verify_ssl = true

# Custom CA certificate path (optional)
# ca_cert = /etc/ssl/certs/my-ca.pem

# ==============================================================================
# Cache Settings
# ==============================================================================

# Enable token caching to reduce server load
# Default: true
cache_enabled = true

# Cache directory
# Default: /var/cache/pam_llng
cache_dir = /var/cache/pam_llng

# Cache TTL in seconds (time to live)
# Cached results expire after this time
# Default: 300 (5 minutes)
cache_ttl = 300

# ==============================================================================
# Operation Mode
# ==============================================================================

# Authorization-only mode
# When set to true, pam_sm_authenticate always succeeds (for SSH key auth)
# and only pam_sm_acct_mgmt performs authorization checks
# Default: false
authorize_only = false

# ==============================================================================
# Logging
# ==============================================================================

# Log level: error, warn, info, debug (or 0-3)
# Default: warn
log_level = warn

# ==============================================================================
# Bastion JWT Verification (for backend servers)
# ==============================================================================

# Require JWT from bastion for authentication
# When enabled, connections without a valid bastion JWT are rejected
# Default: false
# bastion_jwt_required = false

# Expected JWT issuer (LLNG portal URL)
# Must match the portal that signed the JWT
# bastion_jwt_issuer = https://auth.example.com

# JWKS endpoint URL for public key retrieval
# Default: {portal_url}/.well-known/jwks.json
# bastion_jwt_jwks_url = https://auth.example.com/.well-known/jwks.json

# Local cache file for JWKS (enables offline verification)
# Default: /var/cache/pam_llng/jwks.json
# bastion_jwt_jwks_cache = /var/cache/pam_llng/jwks.json

# JWKS cache TTL in seconds
# Default: 3600 (1 hour)
# bastion_jwt_cache_ttl = 3600

# Allowed clock skew in seconds for JWT expiration checks
# Default: 60
# bastion_jwt_clock_skew = 60

# Comma-separated list of allowed bastion IDs (client_id)
# Leave empty to allow all bastions
# bastion_jwt_allowed_bastions = bastion-prod-01,bastion-prod-02

# ==============================================================================
# JWT Replay Detection
# ==============================================================================

# Enable JTI-based replay detection
# Each JWT ID (jti) is cached and rejected if reused
# Default: true
# bastion_jwt_replay_detection = true

# Maximum number of JTI entries in cache
# Should be large enough to hold all expected JTIs during their TTL
# Default: 10000
# bastion_jwt_replay_cache_size = 10000

# Cleanup interval for expired JTI entries (seconds)
# Default: 60
# bastion_jwt_replay_cleanup_interval = 60

# ==============================================================================
# CrowdSec Integration (optional)
# ==============================================================================
# CrowdSec provides collaborative threat detection and IP blocking.
# See https://www.crowdsec.net/ for more information.
# For centralized management, consider using Crowdsieve:
# https://github.com/linagora/crowdsieve

# Enable CrowdSec integration
# Default: false
# crowdsec_enabled = false

# CrowdSec LAPI URL
# Default: http://127.0.0.1:8080
# crowdsec_url = http://127.0.0.1:8080

# HTTP timeout for CrowdSec requests (seconds)
# Default: 5
# crowdsec_timeout = 5

# Fail-open behavior when CrowdSec is unavailable
# true = allow authentication if CrowdSec cannot be reached
# false = deny authentication if CrowdSec cannot be reached
# Default: true
# crowdsec_fail_open = true

# ------------------------------------------------------------------------------
# Bouncer settings (pre-authentication IP blocking)
# ------------------------------------------------------------------------------

# Bouncer API key from: cscli bouncers add open-bastion
# Required for IP blocking functionality
# crowdsec_bouncer_key = your-bouncer-api-key

# Action when IP is banned: reject or warn
# reject = block authentication
# warn = log warning but allow authentication
# Default: reject
# crowdsec_action = reject

# ------------------------------------------------------------------------------
# Watcher settings (post-authentication alert reporting)
# ------------------------------------------------------------------------------

# Machine ID and password from: cscli machines add open-bastion --password <pw>
# Required for sending alerts to CrowdSec
# crowdsec_machine_id = open-bastion
# crowdsec_password = your-machine-password

# Scenario name for alerts
# Default: open-bastion/ssh-auth-failure
# crowdsec_scenario = open-bastion/ssh-auth-failure

# Send all alerts or only ban decisions
# true = send every authentication failure as an alert
# false = only send alerts when auto-ban threshold is reached
# Default: true
# crowdsec_send_all_alerts = true

# Auto-ban threshold: ban IP after N failures in time window
# Set to 0 to disable auto-banning (only report alerts)
# Default: 5
# crowdsec_max_failures = 5

# Time window for counting failures (seconds)
# Default: 180 (3 minutes)
# crowdsec_block_delay = 180

# Ban duration (e.g., 4h, 1d, 1w)
# Default: 4h
# crowdsec_ban_duration = 4h

# ==============================================================================
# SSH Key Policy (optional restrictions on allowed key types)
# ==============================================================================
# Optionally restrict which SSH key types and sizes are allowed for
# authentication. This is useful for enforcing security policies that
# require modern key types or minimum key sizes.

# Enable SSH key policy enforcement
# When enabled, connections with non-compliant keys are rejected
# Default: false
# ssh_key_policy_enabled = false

# Allowed key types (comma-separated)
# Valid values: ed25519, ecdsa, rsa, dsa, sk (FIDO2), all
# Note: "all" does not include DSA (deprecated) - must be explicitly added
# Default: all (when policy is disabled)
# Examples:
#   ssh_key_allowed_types = ed25519            # Only Ed25519 (most secure)
#   ssh_key_allowed_types = ed25519,ecdsa      # Modern curves only
#   ssh_key_allowed_types = ed25519,ecdsa,rsa  # Common secure types
#   ssh_key_allowed_types = all                # All types except DSA
# ssh_key_allowed_types = ed25519,ecdsa,rsa

# Minimum RSA key size in bits
# Common values: 2048 (minimum recommended), 3072 (recommended), 4096 (high security)
# Note: RSA key size cannot always be determined from the connection;
# this is enforced when size information is available.
# Default: 2048
# ssh_key_min_rsa_bits = 2048

# Minimum ECDSA key size in bits
# Valid values: 256 (P-256), 384 (P-384), 521 (P-521)
# Note: P-256 provides ~128-bit security, P-384 ~192-bit, P-521 ~256-bit
# Default: 256
# ssh_key_min_ecdsa_bits = 256

# ==============================================================================
# Cache Brute-Force Protection (offline mode security)
# ==============================================================================
# When the LLNG server is unavailable, the module uses cached authorization
# data. This can be exploited by attackers to brute-force access by trying
# many usernames against the cache. These settings add rate limiting to
# cache lookups to prevent such attacks.

# Enable cache lookup rate limiting
# When enabled, ALL cache lookups are counted per user (hits and misses)
# to prevent enumeration. Users are locked out after max_attempts.
# Only authorized cache hits reset the counter.
# Default: false
# cache_rate_limit_enabled = false

# Maximum cache lookup attempts before lockout
# After this many lookups, the user is locked out from cache access.
# This is intentionally stricter than network rate limiting since cache
# lookups are much faster and easier to brute-force.
# Default: 3
# cache_rate_limit_max_attempts = 3

# Initial lockout duration in seconds
# How long to lock out a user after exceeding max_attempts.
# Uses exponential backoff (doubles on each subsequent lockout).
# Default: 60 (1 minute)
# cache_rate_limit_lockout_sec = 60

# Maximum lockout duration in seconds
# Upper limit for exponential backoff.
# Default: 3600 (1 hour)
# cache_rate_limit_max_lockout_sec = 3600
