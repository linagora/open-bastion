# PAM LemonLDAP::NG Configuration File
# /etc/security/pam_llng.conf

# ==============================================================================
# Required Settings
# ==============================================================================

# LemonLDAP::NG portal URL
portal_url = https://auth.example.com

# OIDC client credentials (must match the RP configured in LLNG)
client_id = pam-access
client_secret = your-client-secret-here

# ==============================================================================
# Server Authentication
# ==============================================================================

# Path to file containing the server's access token
# This token is obtained during server enrollment via Device Authorization Grant
# The file should contain only the token and be readable only by root
server_token_file = /etc/security/pam_llng.token

# Server group name for authorization rules
# This must match a group defined in LLNG's pamAccessServerGroups
# Default: "default"
server_group = default

# ==============================================================================
# HTTP Settings
# ==============================================================================

# HTTP timeout in seconds
# Default: 10
timeout = 10

# Verify SSL certificates
# Set to false only for testing with self-signed certificates
# Default: true
verify_ssl = true

# Custom CA certificate path (optional)
# ca_cert = /etc/ssl/certs/my-ca.pem

# ==============================================================================
# Cache Settings
# ==============================================================================

# Enable token caching to reduce server load
# Default: true
cache_enabled = true

# Cache directory
# Default: /var/cache/pam_llng
cache_dir = /var/cache/pam_llng

# Cache TTL in seconds (time to live)
# Cached results expire after this time
# Default: 300 (5 minutes)
cache_ttl = 300

# ==============================================================================
# Operation Mode
# ==============================================================================

# Authorization-only mode
# When set to true, pam_sm_authenticate always succeeds (for SSH key auth)
# and only pam_sm_acct_mgmt performs authorization checks
# Default: false
authorize_only = false

# ==============================================================================
# Logging
# ==============================================================================

# Log level: error, warn, info, debug (or 0-3)
# Default: warn
log_level = warn

# ==============================================================================
# Desktop SSO / OAuth2 Token Authentication (for LightDM greeter)
# ==============================================================================
# This mode is used for desktop login via LightDM greeter, where the user
# authenticates through an LLNG iframe and receives an OAuth2 access token.

# Enable OAuth2 access token authentication
# When enabled, the PAM module accepts standard OAuth2 access tokens
# instead of one-time PAM tokens. Tokens are validated via /oauth2/introspect.
# Default: false
# oauth2_token_auth = false

# Cache successful OAuth2 authentications for offline mode
# When enabled, credentials are securely cached for offline fallback
# Default: true
# oauth2_token_cache = true

# Minimum remaining TTL for token acceptance (seconds)
# Tokens expiring sooner than this value are rejected to avoid
# session interruptions shortly after login
# Default: 60
# oauth2_token_min_ttl = 60

# ==============================================================================
# Offline Credential Cache (for Desktop SSO offline mode)
# ==============================================================================
# Securely cache user credentials for offline authentication when the LLNG
# server is unreachable. Uses Argon2id for password hashing and AES-256-GCM
# for encryption. Cached credentials are bound to the machine-id.

# Enable offline credential caching
# When enabled, successful online authentications cache credentials for
# offline fallback. This allows users to login when the server is down.
# Default: false
# offline_cache_enabled = false

# Directory for credential cache files
# Must be accessible by the PAM module (root-owned, mode 700)
# Default: /var/cache/open-bastion/credentials
# offline_cache_dir = /var/cache/open-bastion/credentials

# Credential cache TTL in seconds
# How long cached credentials remain valid
# Range: 3600 (1 hour) to 2592000 (30 days)
# Default: 604800 (7 days)
# offline_cache_ttl = 604800

# Maximum failed attempts before lockout
# After this many consecutive failed offline attempts, the cached entry
# is locked and requires online authentication to unlock
# Range: 1 to 20
# Default: 5
# offline_cache_max_failures = 5

# Lockout duration in seconds after max failures
# Range: 60 (1 minute) to 86400 (24 hours)
# Default: 300 (5 minutes)
# offline_cache_lockout = 300

# ==============================================================================
# Offline Session Revalidation (for ob-session-monitor service)
# ==============================================================================
# When enabled, the ob-session-monitor service checks whether offline-authenticated
# sessions are still valid when network connectivity returns.

# Enable network revalidation of offline sessions
# Default: true
# offline_revalidation_enabled = true

# Grace period in seconds: if offline cache is older than this, force online
# re-authentication on next screen unlock
# Range: 600 (10 minutes) to 86400 (24 hours)
# Default: 14400 (4 hours)
# offline_revalidation_grace = 14400

# Maximum time SSO portal can be unreachable while general network is up
# before terminating all offline sessions (anti-firewall-bypass protection)
# Range: 600 (10 minutes) to 86400 (24 hours)
# Default: 3600 (1 hour)
# offline_max_sso_unreachable = 3600

# ==============================================================================
# Bastion JWT Verification (for backend servers)
# ==============================================================================

# Require JWT from bastion for authentication
# When enabled, connections without a valid bastion JWT are rejected
# Default: false
# bastion_jwt_required = false

# Expected JWT issuer (LLNG portal URL)
# Must match the portal that signed the JWT
# bastion_jwt_issuer = https://auth.example.com

# JWKS endpoint URL for public key retrieval
# Default: {portal_url}/.well-known/jwks.json
# bastion_jwt_jwks_url = https://auth.example.com/.well-known/jwks.json

# Local cache file for JWKS (enables offline verification)
# Default: /var/cache/pam_llng/jwks.json
# bastion_jwt_jwks_cache = /var/cache/pam_llng/jwks.json

# JWKS cache TTL in seconds
# Default: 3600 (1 hour)
# bastion_jwt_cache_ttl = 3600

# Allowed clock skew in seconds for JWT expiration checks
# Default: 60
# bastion_jwt_clock_skew = 60

# Comma-separated list of allowed bastion IDs (client_id)
# Leave empty to allow all bastions
# bastion_jwt_allowed_bastions = bastion-prod-01,bastion-prod-02

# ==============================================================================
# JWT Replay Detection
# ==============================================================================

# Enable JTI-based replay detection
# Each JWT ID (jti) is cached and rejected if reused
# Default: true
# bastion_jwt_replay_detection = true

# Maximum number of JTI entries in cache
# Should be large enough to hold all expected JTIs during their TTL
# Default: 10000
# bastion_jwt_replay_cache_size = 10000

# Cleanup interval for expired JTI entries (seconds)
# Default: 60
# bastion_jwt_replay_cleanup_interval = 60

# ==============================================================================
# CrowdSec Integration (optional)
# ==============================================================================
# CrowdSec provides collaborative threat detection and IP blocking.
# See https://www.crowdsec.net/ for more information.
# For centralized management, consider using Crowdsieve:
# https://github.com/linagora/crowdsieve

# Enable CrowdSec integration
# Default: false
# crowdsec_enabled = false

# CrowdSec LAPI URL
# Default: http://127.0.0.1:8080
# crowdsec_url = http://127.0.0.1:8080

# HTTP timeout for CrowdSec requests (seconds)
# Default: 5
# crowdsec_timeout = 5

# Fail-open behavior when CrowdSec is unavailable
# true = allow authentication if CrowdSec cannot be reached
# false = deny authentication if CrowdSec cannot be reached
# Default: true
# crowdsec_fail_open = true

# ------------------------------------------------------------------------------
# Bouncer settings (pre-authentication IP blocking)
# ------------------------------------------------------------------------------

# Bouncer API key from: cscli bouncers add open-bastion
# Required for IP blocking functionality
# crowdsec_bouncer_key = your-bouncer-api-key

# Action when IP is banned: reject or warn
# reject = block authentication
# warn = log warning but allow authentication
# Default: reject
# crowdsec_action = reject

# ------------------------------------------------------------------------------
# Watcher settings (post-authentication alert reporting)
# ------------------------------------------------------------------------------

# Machine ID and password from: cscli machines add open-bastion --password <pw>
# Required for sending alerts to CrowdSec
# crowdsec_machine_id = open-bastion
# crowdsec_password = your-machine-password

# Scenario name for alerts
# Default: open-bastion/ssh-auth-failure
# crowdsec_scenario = open-bastion/ssh-auth-failure

# Send all alerts or only ban decisions
# true = send every authentication failure as an alert
# false = only send alerts when auto-ban threshold is reached
# Default: true
# crowdsec_send_all_alerts = true

# Auto-ban threshold: ban IP after N failures in time window
# Set to 0 to disable auto-banning (only report alerts)
# Default: 5
# crowdsec_max_failures = 5

# Time window for counting failures (seconds)
# Default: 180 (3 minutes)
# crowdsec_block_delay = 180

# Ban duration (e.g., 4h, 1d, 1w)
# Default: 4h
# crowdsec_ban_duration = 4h
